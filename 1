WebAssembly Runtime Daemon (wrtd)
===================================
✓ WASI enabled:
  - Version: Preview2
  - Filesystem paths: 0
  - Environment variables: 0
  - Program arguments: 0
✓ Component model enabled with 0 interfaces
[INFO] Enabling platform optimizations
[INFO] Platform optimizations enabled
[INFO] Initializing WASI host functions
[INFO] WASI host functions registered
[INFO] Initializing component model
[INFO] Component model initialized
[INFO] Starting module execution
[INFO] Executing WebAssembly component
[PARSE] parse_core_module_section: section size=2247499, count=0
[PARSE] Count is 0 but section has data - checking if inline format
[PARSE] Found inline core module (WASM magic at offset 0)
[PARSE] Parsing inline core module format
[DECODER] Section 0x01 (Core Module): parsed 1 modules
[DECODER] Total modules in component: 1
[PARSE] parse_core_module_section: section size=5156, count=0
[PARSE] Count is 0 but section has data - checking if inline format
[PARSE] Found inline core module (WASM magic at offset 0)
[PARSE] Parsing inline core module format
[DECODER] Section 0x01 (Core Module): parsed 1 modules
[DECODER] Total modules in component: 2
[PARSE] parse_core_module_section: section size=670, count=0
[PARSE] Count is 0 but section has data - checking if inline format
[PARSE] Found inline core module (WASM magic at offset 0)
[PARSE] Parsing inline core module format
[DECODER] Section 0x01 (Core Module): parsed 1 modules
[DECODER] Total modules in component: 3
[PARSE] parse_core_module_section: section size=184, count=0
[PARSE] Count is 0 but section has data - checking if inline format
[PARSE] Found inline core module (WASM magic at offset 0)
[PARSE] Parsing inline core module format
[DECODER] Section 0x01 (Core Module): parsed 1 modules
[DECODER] Total modules in component: 4
[INFO] Component parsed successfully
=== STEP 1: Building Type Index ===
Total types to index: 4
  Type[0]: Instance
  Type[1]: Instance
  Type[2]: Value
  Type[3]: Function
    ├─ Params: 0
    └─ Results: 0
✓ Type index built: 4 entries

=== STEP 4: Module Extraction and Validation ===
Total modules to extract: 4
  Module[0]:
    ├─ Size: 2247499 bytes
    ├─ Magic: ✓ (valid WASM)
    ├─ Version: 1
    └─ Type: Core Module ✓
  Module[1]:
    ├─ Size: 5156 bytes
    ├─ Magic: ✓ (valid WASM)
    ├─ Version: 1
    └─ Type: Core Module ✓
  Module[2]:
    ├─ Size: 670 bytes
    ├─ Magic: ✓ (valid WASM)
    ├─ Version: 1
    └─ Type: Core Module ✓
  Module[3]:
    ├─ Size: 184 bytes
    ├─ Magic: ✓ (valid WASM)
    ├─ Version: 1
    └─ Type: Core Module ✓
✓ Extracted 4 valid modules

=== STEP 5: Canonical ABI Operations ===
Total operations: 13
  Canon[0]: Resource.Drop
    └─ Type: type[9]
  Canon[1]: Resource.Drop
    └─ Type: type[10]
  Canon[2]: Lower
    └─ Component func[0] → Core
  Canon[3]: Lower
    └─ Component func[1] → Core
  Canon[4]: Resource.Drop
    └─ Type: type[11]
  Canon[5]: Resource.Drop
    └─ Type: type[12]
  Canon[6]: Lower
    └─ Component func[2] → Core
  Canon[7]: Lower
    └─ Component func[3] → Core
  Canon[8]: Lower
    └─ Component func[4] → Core
  Canon[9]: Lower
    └─ Component func[5] → Core
  Canon[10]: Lower
    └─ Component func[6] → Core
  Canon[11]: Lower
    └─ Component func[7] → Core
  Canon[12]: Lift
    ├─ Core func[25] → Component
    └─ Type: type[14]
✓ Parsed 13 canonical operations

=== STEP 6a: Component Exports ===
Total exports: 1
  Export[0]: "wasi:cli/run@0.2.6"
    ├─ Sort: Instance
    ├─ Index: 6
    ├─ Type: (not specified)
    └─ (end)
✓ Parsed 1 exports

=== STEP 6b: Component Imports ===
Total imports: 6
  Import[0]: ":wasi:io/error@0.2.6"
    ├─ Type: Type
    │  └─ Bounds: 0
    └─ (end)
  Import[1]: ":wasi:io/streams@0.2.6"
    ├─ Type: Type
    │  └─ Bounds: 2
    └─ (end)
  Import[2]: ":wasi:cli/environment@0.2.6"
    ├─ Type: Type
    │  └─ Bounds: 3
    └─ (end)
  Import[3]: ":wasi:cli/exit@0.2.6"
    ├─ Type: Type
    │  └─ Bounds: 4
    └─ (end)
  Import[4]: ":wasi:cli/stdout@0.2.6"
    ├─ Type: Type
    │  └─ Bounds: 6
    └─ (end)
  Import[5]: ":wasi:cli/stderr@0.2.6"
    ├─ Type: Type
    │  └─ Bounds: 8
    └─ (end)
✓ Parsed 6 imports

[WASI-PROVIDER] Creating instance 100 for wasi:io/error@0.2.6
[WASI-PROVIDER] Added export: [method]error.to-debug-string (index 1000)
[WASI-PROVIDER] Instance 100 created with 1 exports
[WASI-PROVIDER] Creating instance 101 for wasi:io/streams@0.2.6
[WASI-PROVIDER] Added export: [method]output-stream.blocking-write-and-flush (index 1001)
[WASI-PROVIDER] Added export: [method]input-stream.blocking-read (index 1002)
[WASI-PROVIDER] Added export: [method]output-stream.blocking-flush (index 1003)
[WASI-PROVIDER] Added export: [method]output-stream.write (index 1004)
[WASI-PROVIDER] Added export: [method]input-stream.read (index 1005)
[WASI-PROVIDER] Instance 101 created with 5 exports
[WASI-PROVIDER] Creating instance 102 for wasi:cli/environment@0.2.6
[WASI-PROVIDER] Added export: get-environment (index 1006)
[WASI-PROVIDER] Added export: get-arguments (index 1007)
[WASI-PROVIDER] Instance 102 created with 2 exports
[WASI-PROVIDER] Creating instance 103 for wasi:cli/exit@0.2.6
[WASI-PROVIDER] Added export: exit (index 1008)
[WASI-PROVIDER] Instance 103 created with 1 exports
[WASI-PROVIDER] Creating instance 104 for wasi:cli/stdout@0.2.6
[WASI-PROVIDER] Added export: get-stdout (index 1009)
[WASI-PROVIDER] Instance 104 created with 1 exports
[WASI-PROVIDER] Creating instance 105 for wasi:cli/stderr@0.2.6
[WASI-PROVIDER] Added export: get-stderr (index 1010)
[WASI-PROVIDER] Instance 105 created with 1 exports
[LINKER] Successfully resolved 6 / 6 imports
    ├─ Instantiate module 2 with 0 import args
    ├─ Binary size: 670 bytes
    ├─ Loading module into engine...
    ├─ Module loaded as handle ModuleHandle(1)
    ├─ Module has 0 import namespaces: []
    ├─ Registering 0 import links...
    │  └─ WARNING: No import args provided, module may fail if it needs imports!
    ├─ Instantiating module...
    ├─ ✓ Instantiated as instance InstanceHandle(1)
    └─ Instance ready
    ├─ InlineExports with 2 exports
    │  ├─ Export[0]: name='[resource-drop]error', sort=Function
    │  ├─ Export[1]: name='[method]error.to-debug-string', sort=Function
    │  ├─ Export[1] '[method]error.to-debug-string' (sort=Function) -> instance 0 export '0'
    ├─ Mapping to source instance 0 (handle InstanceHandle(1))
    └─ Mapped
    ├─ InlineExports with 2 exports
    │  ├─ Export[2]: name='[resource-drop]output-stream', sort=Function
    │  ├─ Export[3]: name='[method]output-stream.blocking-write-and-flush', sort=Function
    │  ├─ Export[3] '[method]output-stream.blocking-write-and-flush' (sort=Function) -> instance 0 export '1'
    ├─ Mapping to source instance 0 (handle InstanceHandle(1))
    └─ Mapped
    ├─ InlineExports with 1 exports
    │  ├─ Export[4]: name='get-stderr', sort=Function
    └─ Export references canonical function
        - Export[4] name='get-stderr' sort=Function
    └─ WARNING: Non-wasip2 canonical function not yet supported
    └─ Stub instance created (non-wasip2 canonicals not functional)
    ├─ InlineExports with 1 exports
    │  ├─ Export[5]: name='get-stdout', sort=Function
    └─ Export references canonical function
        - Export[5] name='get-stdout' sort=Function
    └─ WARNING: Non-wasip2 canonical function not yet supported
    └─ Stub instance created (non-wasip2 canonicals not functional)
    ├─ InlineExports with 3 exports
    │  ├─ Export[6]: name='environ_get', sort=Function
    │  ├─ Export[7]: name='environ_sizes_get', sort=Function
    │  ├─ Export[8]: name='proc_exit', sort=Function
    │  ├─ Export[6] 'environ_get' (sort=Function) -> instance 0 export '2'
    ├─ Mapping to source instance 0 (handle InstanceHandle(1))
    └─ Mapped
    ├─ Instantiate module 0 with 5 import args
    ├─ Binary size: 2247499 bytes
    ├─ *** THIS IS MODULE 0 - THE MAIN MODULE WITH GLOBALS ***
    ├─ *** Being instantiated as CoreInstance[6] ***
    ├─ Loading module into engine...
    ├─ Module loaded as handle ModuleHandle(2)
    ├─ Module has 0 import namespaces: []
    ├─ Registering 5 import links...
    │  ├─ Import 'wasi:io/error@0.2.4' from instance 1
    │  │  ├─ Using import module: ''
    │  │  └─ ✓ Linked
    │  ├─ Import 'wasi:io/streams@0.2.4' from instance 2
    │  │  ├─ Using import module: ''
    │  │  └─ ✓ Linked
    │  ├─ Import 'wasi:cli/stderr@0.2.4' from instance 3
    │  │  ├─ Using import module: ''
    │  │  └─ ✓ Linked
    │  ├─ Import 'wasi:cli/stdout@0.2.4' from instance 4
    │  │  ├─ Using import module: ''
    │  │  └─ ✓ Linked
    │  ├─ Import 'wasi_snapshot_preview1' from instance 5
    │  │  ├─ Using import module: ''
    │  │  └─ ✓ Linked
    ├─ Instantiating module...
    ├─ ✓ Instantiated as instance InstanceHandle(2)
    ├─ *** MODULE 0 INSTANTIATED AS InstanceHandle(2) at index 6 ***
    └─ Instance ready
    ├─ InlineExports with 1 exports
    │  ├─ Export[0]: name='memory', sort=Memory
    │  ├─ Export[0] 'memory' (sort=Memory) -> instance 6 export 'memory'
    ├─ Mapping to source instance 6 (handle InstanceHandle(2))
    └─ Mapped
    ├─ InlineExports with 2 exports
    │  ├─ Export[9]: name='_start', sort=Function
    │  ├─ Export[10]: name='cabi_realloc', sort=Function
    │  ├─ Export[9] '_start' (sort=Function) -> instance 6 export '_start'
    ├─ Mapping to source instance 6 (handle InstanceHandle(2))
    └─ Mapped
    ├─ InlineExports with 1 exports
    │  ├─ Export[11]: name='get-environment', sort=Function
    │  ├─ Export[11] 'get-environment' (sort=Function) -> instance 0 export '5'
    ├─ Mapping to source instance 0 (handle InstanceHandle(1))
    └─ Mapped
    ├─ InlineExports with 2 exports
    │  ├─ Export[12]: name='[resource-drop]output-stream', sort=Function
    │  ├─ Export[13]: name='[method]output-stream.blocking-write-and-flush', sort=Function
    │  ├─ Export[13] '[method]output-stream.blocking-write-and-flush' (sort=Function) -> instance 0 export '6'
    ├─ Mapping to source instance 0 (handle InstanceHandle(1))
    └─ Mapped
    ├─ InlineExports with 1 exports
    │  ├─ Export[14]: name='[resource-drop]error', sort=Function
    └─ Export references canonical function
        - Export[14] name='[resource-drop]error' sort=Function
    └─ WARNING: Non-wasip2 canonical function not yet supported
    └─ Stub instance created (non-wasip2 canonicals not functional)
    ├─ InlineExports with 1 exports
    │  ├─ Export[15]: name='get-stderr', sort=Function
    └─ Export references canonical function
        - Export[15] name='get-stderr' sort=Function
    └─ WARNING: Non-wasip2 canonical function not yet supported
    └─ Stub instance created (non-wasip2 canonicals not functional)
    ├─ InlineExports with 1 exports
    │  ├─ Export[16]: name='exit', sort=Function
    └─ Export references canonical function
        - Export[16] name='exit' sort=Function
    └─ WARNING: Non-wasip2 canonical function not yet supported
    └─ Stub instance created (non-wasip2 canonicals not functional)
    ├─ Instantiate module 1 with 7 import args
    ├─ Binary size: 5156 bytes
    ├─ Loading module into engine...
    ├─ Module loaded as handle ModuleHandle(3)
    ├─ Module has 0 import namespaces: []
    ├─ Registering 7 import links...
    │  ├─ Import 'env' from instance 7
    │  │  ├─ Using import module: ''
    │  │  └─ ✓ Linked
    │  ├─ Import '__main_module__' from instance 8
    │  │  ├─ Using import module: ''
    │  │  └─ ✓ Linked
    │  ├─ Import 'wasi:cli/environment@0.2.6' from instance 9
    │  │  ├─ Using import module: ''
    │  │  └─ ✓ Linked
    │  ├─ Import 'wasi:io/streams@0.2.6' from instance 10
    │  │  ├─ Using import module: ''
    │  │  └─ ✓ Linked
    │  ├─ Import 'wasi:io/error@0.2.6' from instance 11
    │  │  ├─ Using import module: ''
    │  │  └─ ✓ Linked
    │  ├─ Import 'wasi:cli/stderr@0.2.6' from instance 12
    │  │  ├─ Using import module: ''
    │  │  └─ ✓ Linked
    │  ├─ Import 'wasi:cli/exit@0.2.6' from instance 13
    │  │  ├─ Using import module: ''
    │  │  └─ ✓ Linked
    ├─ Instantiating module...
    ├─ ✓ Instantiated as instance InstanceHandle(3)
    └─ Instance ready
    ├─ InlineExports with 8 exports
    │  ├─ Export[0]: name='$imports', sort=Table
    │  ├─ Export[17]: name='0', sort=Function
    │  ├─ Export[18]: name='1', sort=Function
    │  ├─ Export[19]: name='2', sort=Function
    │  ├─ Export[20]: name='3', sort=Function
    │  ├─ Export[21]: name='4', sort=Function
    │  ├─ Export[23]: name='5', sort=Function
    │  ├─ Export[24]: name='6', sort=Function
    │  ├─ Export[0] '$imports' (sort=Table) -> instance 0 export '$imports'
    ├─ Mapping to source instance 0 (handle InstanceHandle(1))
    └─ Mapped
    ├─ Instantiate module 3 with 1 import args
    ├─ Binary size: 184 bytes
    ├─ Loading module into engine...
    ├─ Module loaded as handle ModuleHandle(4)
    ├─ Module has 0 import namespaces: []
    ├─ Registering 1 import links...
    │  ├─ Import '' from instance 15
    │  │  ├─ Using import module: ''
    │  │  └─ ✓ Linked
    ├─ Instantiating module...
    ├─ ✓ Instantiated as instance InstanceHandle(4)
    └─ Instance ready


=== Resolving Component Exports ===
Total exports to resolve: 1
  Resolving[0]: "wasi:cli/run@0.2.6"
    ├─ Creating ComponentFunction for Sort::Instance
    ├─ Added to instance.functions as Native implementation
    ✓ Resolved
✓ Resolved 1 exports

[INSTANTIATION] Stored 6 resolved imports in instance

=== Component Initialization Complete ===
Modules: 4 binaries stored
Imports: 6 resolved

Start functions will execute when component functions are called
Component ready for execution

=== STEP 2: Type Lookup Test ===
✓ Type lookup successful: Type[0] = Instance
✓ Type lookup successful: Type[1] = Instance
✓ Type lookup successful: Type[2] = Value
✓ Type lookup successful: Type[3] = Function

=== STEP 3: Safe Type Resolution Test ===
✓ Safe resolution successful: Type[0] → Instance
✓ Safe resolution successful: Type[1] → Instance
✓ Safe resolution successful: Type[2] → Value
✓ Safe resolution successful: Type[3] → Function
✓ Correctly rejected invalid index 14

[INSTANTIATION] Found instance 13 mapped to: InstanceHandle(1)
[INSTANTIATION] This MUST be the instance with module 0 and its initialized globals
[INSTANTIATION] Main instance selected: InstanceHandle(1) (should contain module 0 with _initialize)
[INFO] Component initialized and running successfully

=== Available Exports ===
Total exports: 1
  Export[0]: "wasi:cli/run@0.2.6"

[INFO] Calling wasi:cli/run entry point
[CALL_NATIVE] Calling func[6] in module[0]
[CALL_NATIVE] Executing canonical function 6
[CALL_NATIVE] Module binary size: 2247499 bytes
[TEST-THREAD] Attempting to instantiate module...
[TEST-THREAD] Binary size: 2247499 bytes
[TEST-THREAD] Loading module from binary...
[LOAD_WASM_UNIFIED] Calling extract_module_info...
[PARSER] parse_import_section_info: 9 imports to parse
[PARSER] Processing import 0/9
[PARSER] parse_export_section_info: 4 exports to parse
[PARSER] Processing export 0/4
[PARSER] extract_module_info: Parsing complete, returning result
[PARSER] Final counts - imports: 9, exports: 4
[LOAD_WASM_UNIFIED] extract_module_info returned successfully
[LOAD_WASM_UNIFIED] Boxed module_info
[LOAD_WASM_UNIFIED] Calling extract_builtin_imports...
[LOAD_WASM_UNIFIED] extract_builtin_imports returned successfully
[TEST-THREAD] ✓ Module loaded successfully!
[TEST-THREAD] Exports: 4
[TEST-THREAD] Imports: 9
[TEST-THREAD] Registering all WASI host functions...
[TEST-THREAD] ✓ Registered 36 WASI host functions (stub implementations)
[TEST-THREAD] Loading module into engine...
[TEST-THREAD] ✓ Engine and instance ready
[TEST-THREAD] Step 1: Call _initialize to set up runtime globals...
[TEST-THREAD] ⚠ _initialize failed: Error { category: Runtime, code: 2010, message: "Function not found in exports" }
[TEST-THREAD] Continuing anyway - some components work without it
[TEST-THREAD] Step 2: Looking for main entry points...
[TEST-THREAD] Trying to call function: wasi:cli/run@0.2.0#run
[TEST-THREAD] Function wasi:cli/run@0.2.0#run not found or failed: Error { category: Runtime, code: 2010, message: "Function not found in exports" }
[TEST-THREAD] Trying to call function: _start
Hello wasm component world from Rust!
[TEST-THREAD] Function _start not found or failed: Error { category: Runtime, code: 8601, message: "Drop: stack underflow" }
[TEST-THREAD] No standard entry point found, module loaded but not executed
[TEST-THREAD] Module instantiated and execution attempted
[CALL_NATIVE] Function execution completed
[INFO] Component executed successfully
[INFO] Module execution completed successfully
✓ Execution completed successfully
  Modules executed: 1
  Components executed: 0
  Fuel consumed: 225572
  Peak memory: 4511442 bytes
  Host functions registered: 3
  WASI functions called: 0
  Cross-component calls: 0
